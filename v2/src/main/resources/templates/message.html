<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta http-equiv="Content-Style-Type" content="text/css" />
	<meta http-equiv="Content-Script-Type" content="text/javascript" />
	<meta name="auther" content="株式会社BURIPANDA" />
	<meta name="copyright" content="Copyright &copy; BURIPANDA CO., LTD. " />
	<title>メッセージ一覧画面</title>
	<link th:href="@{/css/root.css}" rel="stylesheet">
	<link th:href="@{/css/sidemenu.css}" rel="stylesheet">
	<link th:href="@{/css/message.css}" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js"></script>
	<script src="https://kit.fontawesome.com/e737952f6c.js" crossorigin="anonymous"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="/js/common.js"></script>
	<script>
	
    var stompClient = null;
	var sendId = null;
	var distId = "[[${session.v2bean.id}]]";

	$(function(){
	  $('#textarea')
	  .on('input', function(){
	    if ($(this).outerHeight() > this.scrollHeight){
	      $(this).height(1)
	    }
	    while ($(this).outerHeight() < this.scrollHeight){
	      $(this).height($(this).height() + 1)
	    }
	  });
	});
	
	function loadPage(){
        $("#content-frame").load(
			"/getMessageData",
			{distId: distId, sendId: sendId},
			function(){
				// スクロールを下へ
				let chatArea = document.getElementById('content-frame');
				chatArea.scrollTop = chatArea.scrollHeight;
			});
    }
    
    // 左のユーザを選択した時
    function viewMessage(selectId) {
		console.log("sendId:" + selectId);
		if (selectId != 0) {
			// 送信先ユーザID設定
			sendId = selectId;
			var user_content = document.getElementById("pid" + sendId);
			var clone_element = user_content.cloneNode(true);
			clone_element.id = "select_user";			
			var select_user_content = document.getElementById("select_user");
			select_user_content.replaceWith(clone_element);
			// メッセージ一覧取得
			loadPage();
		}

	}
	/*
	function sendMessage(){
		
		var message = document.getElementById("textarea").value;

		if (message != "") {
			document.getElementById("textarea").value = "";
	        $("#content-frame").load(
				"/sendMessageData",
				{message: message},
				function(){});
		}
    }
    */
    
    // 以下はWebSocket通信	
	function setConnected(connected) {
	    $("#connect").prop("disabled", connected);
	    $("#disconnect").prop("disabled", !connected);
	    if (connected) {
	        $("#conversation").show();
	    }
	    else {
	        $("#conversation").hide();
	    }
	    $("#greetings").html("");
	}
	
	function connect() {
	    var socket = new SockJS('/v2-websocket');
	    stompClient = Stomp.over(socket);
	    stompClient.connect({}, function (after) {
	        //setConnected(true);
	        console.log('Connected: ' + after);
	        var toRecivePath = "/topic/greetings/" + distId;
	        stompClient.subscribe(toRecivePath, function (ws_essage) {
				console.log(JSON.parse(ws_essage.body).content);
				// メッセージ一覧取得
				loadPage();
	        });
	    });
	}
	
	function disconnect() {
	    if (stompClient !== null) {
	        stompClient.disconnect();
	    }
	    setConnected(false);
	    console.log("Disconnected");
	}
	
	async function sendMessage() {
		var toSendPath = "/v2/chat";
		var message = document.getElementById("textarea").value;

		if (message != "") {
			// wsで相手に通知＆メッセージ登録
		    stompClient.send(toSendPath, {}, JSON.stringify(
			{'sendId': sendId,'distId': distId, 'mode': 0,'message': message}));
			// 入力欄クリア
			document.getElementById("textarea").value = "";
			await new Promise(s => setTimeout(s, 200));
	        // 画面リロード
	        loadPage();
		}
	}
	
	function showGreeting(message) {
	    //$("#greetings").append("<tr><td>" + message + "</td></tr>");
	}
	
	$(function () {
	    //$("form").on('submit', function (e) {
	    //    e.preventDefault();
	    //});
	    $( "#connect" ).click(function() { connect(); });
	    $( "#disconnect" ).click(function() { disconnect(); });
	    $( "#send" ).click(function() { sendMessage(); });
	});
	window.onload = connect();
	</script>
</head>

<body>
<th:block th:replace="sidemenu::sidemenu"></th:block>
<div class="contents">
<form method="post" name="form1" enctype="multipart/form-data" action="/chat/soshin">
	<div class="title"><img src="/image/banaer2.jpg"></div>
<div class="message">
	<div class="left_content">
		<div class="left_header"></div>
		<div class="partner_list">
			<th:blcok th:each="partner, partnerStat : ${partnerList}">
			<div class="partner" th:onclick="|javascript:viewMessage(__${partner.id}__)|">
			<div class="partner_inner" th:id="|pid__${partner.id}__|">
				<div><img th:src="@{./getImgDefault?id=__${partner.id}__&name=__${partner.imageFile}__}" class="img_mini"></div>
				<div class="partner_name">[[${partner.userName}]]<BR>[[${partner.message}]]</div>
			</div>
			</div>
			</th:blcok>
		</div>
		<div class="left_footer"></div>
	</div>
	<div class="right_content">	
		<div class="right_title">
			<div id="select_user"></div>
		</div>
		<div class="right_chat" id="content-frame"></div>
		<div class="right_buttom">
			<textarea name="message" rows="1" cols="50" placeholder="メッセージを入力" id="textarea"></textarea>
			<div class="soshin" onclick="javascript:sendMessage()">送信</div>
		</div>
	</div>
</div>
</div>
</form>
<script type="text/javascript">
	viewMessage("[[${session.v2bean.cpid}]]");
</script>
</body>
</html>